<aside class="sidebar right-sidebar" [class.open]="activeView() !== null">
  @if (activeView() === 'ranking') {
    <div class="sidebar-content ranking-view">
      <div class="sidebar-header">
        <h3>
          <span class="material-icons header-icon">military_tech</span>
          Mi Ranking
        </h3>
        <span class="ranking-count">{{ rankedSongs().length }} canciones</span>
      </div>
      
      @if (loadingRanking()) {
        <div class="loading-state">
          <span class="material-icons spinning">autorenew</span>
          <p>Cargando...</p>
        </div>
      } @else if (rankedSongs().length === 0) {
        <div class="ranking-empty">
          <span class="material-icons">emoji_events</span>
          <p>Tu ranking está vacío</p>
          <span class="hint">Añade canciones desde la carátula</span>
        </div>
      } @else {
        <div class="ranking-list" cdkDropList (cdkDropListDropped)="onRankingDrop($event)">
          @for (song of rankedSongs(); track song.id; let i = $index) {
            <div 
              class="ranking-item" 
              cdkDrag
              [class.current]="song.id === currentSongId()"
              (click)="onPlayFromRanking(song)"
            >
              <div class="drag-handle" cdkDragHandle>
                <span class="material-icons">drag_indicator</span>
              </div>
              <span class="rank-position">{{ i + 1 }}</span>
              <img [src]="getCoverUrl(song)" alt="" class="ranking-cover">
              <div class="song-info">
                <span class="song-title">{{ song.title }}</span>
                <span class="song-artist">{{ song.artist }}</span>
              </div>
              <span class="song-duration">{{ formatDuration(song.duration) }}</span>
              <button 
                class="remove-btn" 
                (click)="removeFromRanking(song, $event)"
                title="Quitar del ranking"
              >
                <span class="material-icons">close</span>
              </button>
            </div>
          }
        </div>
      }
    </div>
  }
  
  @if (activeView() === 'playlist') {
    <div class="sidebar-content">
      <h3>Biblioteca</h3>
      
      <!-- Opción especial: Todas las canciones -->
      <div class="playlist-list library-section">
        <div class="playlist-item library-item" (click)="onPlayLibrary()">
          <button 
            class="play-btn always-visible" 
            title="Reproducir todas"
          >
            <span class="material-icons">play_arrow</span>
          </button>
          <span class="material-icons playlist-icon">library_music</span>
          <div class="playlist-info">
            <span class="playlist-name">Todas las canciones</span>
            <span class="playlist-count">Biblioteca completa</span>
          </div>
        </div>
      </div>
      
      <h3 class="section-title">Mis Playlists</h3>
      <div class="playlist-list">
        @if (playlistService.loading()) {
          <div class="loading-state">
            <span class="material-icons spinning">sync</span>
            <span>Cargando playlists...</span>
          </div>
        } @else if (playlists().length === 0) {
          <div class="empty-state">
            <span class="material-icons">queue_music</span>
            <span>No hay playlists creadas</span>
          </div>
        } @else {
          @for (playlist of playlists(); track playlist.id) {
            <div class="playlist-item" [class.contains-current]="playerService.activePlaylistId() === playlist.id">
              <button 
                class="play-btn" 
                (click)="onPlayPlaylist(playlist.id)"
                title="Reproducir playlist"
              >
                <span class="material-icons">play_arrow</span>
              </button>
              <span class="material-icons playlist-icon">{{ playlist.icon }}</span>
              <div class="playlist-info">
                <span class="playlist-name">{{ playlist.name }}</span>
                <span class="playlist-count">{{ playlist.songCount }} canciones</span>
              </div>
              @if (isInPlaylist(playlist.id)) {
                <button 
                  class="remove-btn" 
                  (click)="onRemoveFromPlaylist(playlist.id)"
                  title="Quitar canción de esta playlist"
                >
                  <span class="material-icons">remove</span>
                </button>
              } @else {
                <button 
                  class="add-btn" 
                  (click)="onAddToPlaylist(playlist.id)"
                  title="Agregar canción actual"
                >
                  <span class="material-icons">add</span>
                </button>
              }
              <button 
                class="config-btn" 
                (click)="onConfigPlaylist(playlist)"
                title="Configurar playlist"
              >
                <span class="material-icons">settings</span>
              </button>
            </div>
          }
        }
      </div>
      <button class="create-playlist-btn" (click)="onCreatePlaylist()">
        <span class="material-icons">add</span>
        Nueva playlist
      </button>
    </div>
  }
  
  <!-- Modales de playlist -->
  <app-playlist-config-modal
    [isOpen]="showConfigModal()"
    [playlist]="selectedPlaylist()"
    (closeModal)="closeConfigModal()"
    (openSongSelector)="openSongSelector($event)"
    (playlistDeleted)="onPlaylistDeleted($event)"
  />
  
  <app-song-selector-modal
    [isOpen]="showSongSelector()"
    [playlistId]="selectedPlaylistId()"
    (closeModal)="closeSongSelector()"
  />
  
  @if (activeView() === 'queue') {
    <div class="sidebar-content queue-view">
      <!-- Header con contexto -->
      <div class="queue-header">
        <div class="queue-source">
          <span class="material-icons source-icon">{{ getQueueSourceIcon() }}</span>
          <span class="source-text">{{ getQueueSourceLabel() }}</span>
        </div>
        @if (playerService.playMode() !== 'sequential') {
          <div class="queue-mode">
            <span class="material-icons mode-icon">{{ getPlayModeIcon() }}</span>
            <span class="mode-text">{{ getPlayModeLabel() }}</span>
          </div>
        }
      </div>
      
      <!-- Canción actual destacada -->
      @if (playerService.currentSong(); as currentSong) {
        <div class="now-playing-section">
          <span class="section-label">Reproduciendo ahora</span>
          <div class="now-playing-item">
            <img [src]="getCoverUrl(currentSong)" alt="" class="now-playing-cover">
            <div class="now-playing-info">
              <span class="now-playing-title">{{ currentSong.title }}</span>
              <span class="now-playing-artist">{{ currentSong.artist }}</span>
            </div>
            <span class="material-icons playing-indicator">equalizer</span>
          </div>
        </div>
      }
      
      <!-- Tabs Siguientes / Anteriores -->
      <div class="queue-tabs">
        <button 
          class="tab-btn" 
          [class.active]="queueTab() === 'upcoming'"
          (click)="queueTab.set('upcoming')"
        >
          Siguientes ({{ upcomingSongs().length }})
        </button>
        <button 
          class="tab-btn" 
          [class.active]="queueTab() === 'previous'"
          (click)="queueTab.set('previous')"
        >
          Anteriores ({{ previousSongs().length }})
        </button>
      </div>
      
      <!-- Lista de canciones según tab -->
      @if (queueTab() === 'upcoming') {
        @if (upcomingSongs().length === 0) {
          <div class="queue-empty">
            <span class="material-icons">playlist_play</span>
            <p>No hay más canciones</p>
            <span class="hint">Añade música desde la biblioteca</span>
          </div>
        } @else {
          <div class="queue-list" cdkDropList (cdkDropListDropped)="onQueueDrop($event)">
            @for (song of upcomingSongs(); track song.id; let i = $index) {
              <div 
                class="queue-item" 
                cdkDrag
                [class.next]="i === 0"
                (click)="onPlayFromQueue(song.queueIndex)"
              >
                <div class="drag-handle" cdkDragHandle>
                  <span class="material-icons">drag_indicator</span>
                </div>
                <img [src]="getCoverUrl(song)" alt="" class="queue-cover">
                <div class="queue-info">
                  <span class="queue-title">{{ song.title }}</span>
                  <span class="queue-artist">{{ song.artist }}</span>
                </div>
                <span class="queue-duration">{{ formatDuration(song.duration) }}</span>
                <button 
                  class="remove-btn" 
                  (click)="onRemoveFromQueue(song.queueIndex, $event)"
                  title="Quitar de la cola"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            }
          </div>
        }
      } @else {
        @if (previousSongs().length === 0) {
          <div class="queue-empty">
            <span class="material-icons">history</span>
            <p>No hay canciones anteriores</p>
            <span class="hint">Aquí aparecerán las canciones que ya escuchaste</span>
          </div>
        } @else {
          <div class="queue-list previous-list">
            @for (song of previousSongs(); track song.id; let i = $index) {
              <div 
                class="queue-item previous-item" 
                (click)="onPlayFromQueue(song.queueIndex)"
              >
                <img [src]="getCoverUrl(song)" alt="" class="queue-cover">
                <div class="queue-info">
                  <span class="queue-title">{{ song.title }}</span>
                  <span class="queue-artist">{{ song.artist }}</span>
                </div>
                <span class="queue-duration">{{ formatDuration(song.duration) }}</span>
              </div>
            }
          </div>
        }
      }
    </div>
  }
</aside>
